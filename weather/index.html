<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scarey Weather - Kindersley, SK</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --text-main: #1a1a1a; 
            --text-sub: #65676b; 
            --accent: #0084ff; 
            --high: #ff4757;
            --low: #2ed573;
            --kindersley-blue: #a5b1c2;
            --quote-bg: #e4e6eb;
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            transition: background-color 1.5s ease;
            padding-bottom: 50px;
        }
        
        header { margin-top: 40px; text-align: center; width: 90%; position: relative; }
        h1 { margin: 0; font-weight: 800; letter-spacing: -1px; font-size: 2.5rem; color: var(--text-main); text-transform: uppercase; }
        .location { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; letter-spacing: 1px; margin-bottom: 5px; }
        #timestamp { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; }

        /* Centered and Bigger Calendar Button */
        .cal-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 40px auto;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 20px rgba(0, 132, 255, 0.2);
            z-index: 10;
        }
        .cal-btn:hover { 
            transform: translateY(-3px) scale(1.02); 
            background: #0073e6; 
            box-shadow: 0 15px 30px rgba(0, 132, 255, 0.3);
        }
        .cal-btn:active { transform: translateY(0) scale(0.98); }

        #quote-container {
            background: var(--quote-bg);
            padding: 15px 25px;
            border-radius: 50px;
            margin-bottom: 30px;
            max-width: 80%;
            text-align: center;
            font-style: italic;
            font-weight: 500;
            color: #4b4b4b;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            width: 90%; 
            max-width: 1100px; 
        }
        
        .card { 
            background: var(--card); 
            padding: 30px; 
            border-radius: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .card.wide { grid-column: 1 / -1; min-height: 350px; }
        .card.wide .label { text-align: center; font-size: 1.1rem; justify-content: center; width: 100%; margin-bottom: 15px; letter-spacing: 2px; }

        .icon-bg { position: absolute; top: 20px; right: 20px; opacity: 0.1; color: var(--accent); }
        .label { color: var(--text-sub); text-transform: uppercase; font-size: 0.75rem; font-weight: 700; letter-spacing: 1.2px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;}
        .main-reading { display: flex; align-items: baseline; justify-content: center; margin-bottom: 5px; }
        .secondary-reading { text-align: center; font-size: 1.1rem; color: var(--text-sub); font-weight: 500; margin-bottom: 20px; }
        .value { font-size: 4rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .unit { font-size: 1.5rem; color: var(--text-sub); font-weight: 500; margin-left: 8px; }
        
        .stats-24h { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #eee; padding-top: 20px; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 1.1rem; font-weight: 700; }
        .stat-val.high { color: var(--high); }
        .stat-val.low { color: var(--low); }

        /* Pop-out Calendar Styles */
        #cal-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }
        .cal-content {
            background: var(--bg);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 32px;
            padding: 30px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .cal-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        .cal-nav h2 { margin: 0; font-weight: 800; color: var(--text-main); }
        .nav-btn {
            background: white;
            border: 1px solid #ddd;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #eee; transform: scale(1.1); }

        .close-cal {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-main);
            background: white;
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }
        .cal-day-label { text-align: center; font-weight: 800; font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; padding-bottom: 10px; }
        .cal-cell {
            background: white;
            border-radius: 16px;
            padding: 12px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .cal-cell:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .cal-cell.empty { background: transparent; box-shadow: none; border: none; }
        .cal-date { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .cal-data { margin-top: auto; }
        .cal-temp { font-size: 0.75rem; font-weight: 700; display: flex; justify-content: space-between; }
        .cal-high { color: var(--high); }
        .cal-low { color: var(--low); }
        
        footer { margin-top: 20px; padding: 40px; color: var(--text-sub); font-style: italic; font-size: 0.9rem; text-align: center; line-height: 1.6; }
        body.below-zero { background-color: var(--kindersley-blue); }
        .chart-container { width: 100%; height: 240px; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="location">TREATY 6 • KINDERSLEY, SK</div>
        <h1>Scarey Weather</h1>
        <div id="timestamp">Updating Station Data...</div>
    </header>

    <div id="quote-container">
        "If you don't like the weather in Saskatchewan, wait five minutes."
    </div>

    <div class="dashboard">
        <!-- Main Stats -->
        <div class="card">
            <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg></div>
            <div class="label">Temperature</div>
            <div class="main-reading"><span class="value" id="temp-val">--</span><span class="unit">°C</span></div>
            <div class="secondary-reading" id="temp-f-val">-- °F</div>
            <div class="stats-24h">
                <div class="stat-item"><span class="stat-label">24H High</span><span class="stat-val high" id="temp-high">--</span></div>
                <div class="stat-item"><span class="stat-label">24H Low</span><span class="stat-val low" id="temp-low">--</span></div>
            </div>
        </div>

        <div class="card">
            <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
            <div class="label">Humidity</div>
            <div class="main-reading"><span class="value" id="humi-val">--</span><span class="unit">%</span></div>
            <div class="secondary-reading">&nbsp;</div>
            <div class="stats-24h">
                <div class="stat-item"><span class="stat-label">24H High</span><span class="stat-val high" id="humi-high">--</span></div>
                <div class="stat-item"><span class="stat-label">24H Low</span><span class="stat-val low" id="humi-low">--</span></div>
            </div>
        </div>

        <div class="card">
            <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg></div>
            <div class="label">Sea-Level Pressure</div>
            <div class="main-reading"><span class="value" id="pres-val">--</span><span class="unit">kPa</span></div>
            <div class="secondary-reading" id="pres-hpa-val">-- hPa</div>
            <div class="stats-24h">
                <div class="stat-item"><span class="stat-label">24H High</span><span class="stat-val high" id="pres-high">--</span></div>
                <div class="stat-item"><span class="stat-label">24H Low</span><span class="stat-val low" id="pres-low">--</span></div>
            </div>
        </div>

        <!-- Trends -->
        <div class="card wide">
            <div class="label">24-Hour Temperature Trend</div>
            <div class="chart-container"><canvas id="tempChart"></canvas></div>
        </div>

        <div class="card wide">
            <div class="label">24-Hour Pressure Trend</div>
            <div class="chart-container"><canvas id="presChart"></canvas></div>
        </div>
    </div>

    <!-- Monthly History Button at bottom -->
    <button class="cal-btn" onclick="openCalendar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
        View Monthly History
    </button>

    <!-- Modal Calendar -->
    <div id="cal-modal">
        <div class="cal-content">
            <button class="close-cal" onclick="closeCalendar()">&times;</button>
            
            <div class="cal-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <h2 id="cal-month-year">Month Year</h2>
                <button class="nav-btn" onclick="changeMonth(1)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>

            <div class="calendar-grid" id="calendar-body"></div>
            
            <p style="text-align:center; margin-top: 25px; color: var(--text-sub); font-size: 0.8rem;">
                * History available depends on your Adafruit IO data retention.
            </p>
        </div>
    </div>

    <footer>
        "In the midst of winter, I found there was, within me, an invincible summer."<br>
        <small>Live from the ScareySci Lab • Kindersley, SK</small>
    </footer>

    <script>
        const USER = 'scareysci';
        const KEY = 'aio_vvWE' + '28bkXvSbG2RsFjLaJQxvOJTn';
        const FEEDS = ['temperature', 'humidity', 'pressure'];
        const ELEVATION_M = 683; 

        const wisdom = [
            { min: 30, text: "It's a dry heat, but the mosquitoes are the size of standard drones." },
            { min: 20, max: 30, text: "The perfect Saskatchewan day. Take a picture, it'll change in five minutes." },
            { min: 10, max: 20, text: "Bunny hug weather. Finally." },
            { min: 0, max: 10, text: "T-shirt weather for most of Kindersley. Winter jacket weather for everyone else." },
            { min: -10, max: 0, text: "Just a light frost. Your car will probably start... probably." },
            { min: -25, max: -10, text: "Standard winter. If the wind isn't howling, it's actually quite nice!" },
            { min: -40, max: -25, text: "Colder than a brass toilet seat on the shady side of an iceberg." },
            { max: -40, text: "Absolute Zero. Even the mother-in-law's glare is frozen today." }
        ];

        function getWisdom(temp) {
            return wisdom.find(w => (w.min === undefined || temp >= w.min) && (w.max === undefined || temp < w.max))?.text || "Saskatchewan: Where the wind blows.";
        }

        let currentTempC = 15; 
        let tempChart, presChart;

        // Calendar State
        let displayDate = new Date();

        function openCalendar() {
            document.getElementById('cal-modal').style.display = 'flex';
            renderMonthlyCalendar();
        }

        function closeCalendar() {
            document.getElementById('cal-modal').style.display = 'none';
        }

        function changeMonth(dir) {
            displayDate.setMonth(displayDate.getMonth() + dir);
            renderMonthlyCalendar();
        }

        async function renderMonthlyCalendar() {
            const grid = document.getElementById('calendar-body');
            const title = document.getElementById('cal-month-year');
            
            const month = displayDate.getMonth();
            const year = displayDate.getFullYear();
            
            title.innerText = displayDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding: 40px;">Fetching records...</p>';

            try {
                // Request 30 days of data - Adafruit Free usually keeps 30 days.
                // For a true "scrollable" history beyond 30 days, an Adafruit IO+ account is needed.
                const res = await fetch(`https://io.adafruit.com/api/v2/${USER}/feeds/temperature/data/chart?days=30`, {
                    headers: { 'X-AIO-Key': KEY }
                });
                const history = await res.json();
                
                const dailyStats = {};
                if (history.data) {
                    history.data.forEach(p => {
                        const date = new Date(p[0]);
                        const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                        const val = parseFloat(p[1]);
                        if (!dailyStats[key]) dailyStats[key] = { high: -999, low: 999 };
                        dailyStats[key].high = Math.max(dailyStats[key].high, val);
                        dailyStats[key].low = Math.min(dailyStats[key].low, val);
                    });
                }

                grid.innerHTML = '';
                // Weekday labels
                ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                    grid.innerHTML += `<div class="cal-day-label">${d}</div>`;
                });

                // Calendar padding for start of month
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) {
                    grid.innerHTML += '<div class="cal-cell empty"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const statKey = `${year}-${month}-${day}`;
                    const stats = dailyStats[statKey];
                    
                    grid.innerHTML += `
                        <div class="cal-cell">
                            <div class="cal-date">${day}</div>
                            <div class="cal-data">
                                ${stats ? `
                                    <div class="cal-temp cal-high"><span>H</span><span>${stats.high.toFixed(1)}°</span></div>
                                    <div class="cal-temp cal-low"><span>L</span><span>${stats.low.toFixed(1)}°</span></div>
                                ` : '<div style="color:#ccc; font-size:0.6rem; text-align:center;">NO DATA</div>'}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                grid.innerHTML = `<p style="grid-column: 1/-1; color:red; text-align:center;">Error loading history: ${e.message}</p>`;
            }
        }

        function initCharts() {
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { display: false }, ticks: { color: '#65676b', font: { size: 10 }, maxTicksLimit: 12, autoSkip: true, maxRotation: 0 } },
                    y: { ticks: { font: { size: 10 }, color: '#65676b' }, grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            };
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#ff4757', backgroundColor: 'rgba(255, 71, 87, 0.1)', fill: true, tension: 0.4 }] },
                options: chartOptions
            });
            presChart = new Chart(document.getElementById('presChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#0084ff', backgroundColor: 'rgba(0, 132, 255, 0.1)', fill: true, tension: 0.4 }] },
                options: chartOptions
            });
        }

        function adjustPressure(stationPressureHpa, tempC) {
            return stationPressureHpa * Math.pow(1 - (0.0065 * ELEVATION_M) / (tempC + 0.0065 * ELEVATION_M + 273.15), -5.257);
        }

        async function updateData() {
            try {
                const tempRes = await fetch(`https://io.adafruit.com/api/v2/${USER}/feeds/temperature/data/last`, { headers: { 'X-AIO-Key': KEY } });
                if (tempRes.ok) {
                    const tempData = await tempRes.json();
                    currentTempC = parseFloat(tempData.value);
                }

                for (let f of FEEDS) {
                    const idPrefix = f.substring(0, 4);
                    const res = await fetch(`https://io.adafruit.com/api/v2/${USER}/feeds/${f}/data/last`, { headers: { 'X-AIO-Key': KEY } });
                    if (!res.ok) continue;
                    const data = await res.json();
                    if (data && data.value) {
                        let val = parseFloat(data.value);
                        if (f === 'pressure') {
                            const seaLevelHpa = adjustPressure(val, currentTempC);
                            document.getElementById(`pres-val`).innerText = (seaLevelHpa / 10).toFixed(2);
                            document.getElementById(`pres-hpa-val`).innerText = seaLevelHpa.toFixed(1) + " hPa";
                        } else if (f === 'temperature') {
                            document.getElementById(`temp-val`).innerText = val.toFixed(1);
                            document.getElementById('temp-f-val').innerText = ((val * 1.8) + 32).toFixed(1) + " °F";
                            document.getElementById('timestamp').innerText = "Last Signal: " + new Date(data.created_at).toLocaleTimeString();
                            document.getElementById('quote-container').innerText = `"${getWisdom(val)}"`;
                            if (val < 0) document.body.classList.add('below-zero'); else document.body.classList.remove('below-zero');
                        } else {
                            document.getElementById(`humi-val`).innerText = val.toFixed(1);
                        }
                    }

                    const histRes = await fetch(`https://io.adafruit.com/api/v2/${USER}/feeds/${f}/data/chart?hours=24`, { headers: { 'X-AIO-Key': KEY } });
                    if (histRes.ok) {
                        const histData = await histRes.json();
                        if (histData && histData.data) {
                            let points = histData.data.map(p => parseFloat(p[1])).filter(v => !isNaN(v));
                            let times = histData.data.map(p => {
                                const date = new Date(p[0]);
                                return date.getHours().toString().padStart(2, '0') + ":00";
                            }); 
                            if (f === 'pressure') {
                                points = points.map(p => adjustPressure(p, currentTempC) / 10);
                                presChart.data.labels = times; presChart.data.datasets[0].data = points; presChart.update();
                            } else if (f === 'temperature') {
                                tempChart.data.labels = times; tempChart.data.datasets[0].data = points; tempChart.update();
                            }
                            if (points.length > 0) {
                                document.getElementById(`${idPrefix}-high`).innerText = Math.max(...points).toFixed(f === 'pressure' ? 2 : 1);
                                document.getElementById(`${idPrefix}-low`).innerText = Math.min(...points).toFixed(f === 'pressure' ? 2 : 1);
                            }
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }

        initCharts();
        updateData();
        setInterval(updateData, 30000);
    </script>
</body>
</html>
