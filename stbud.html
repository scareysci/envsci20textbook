<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Studies Study Buddy</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for chat bubbles and layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #chat-container {
            max-width: 800px;
            height: 90vh;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #ffffff;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        /* Custom scrollbar for webkit browsers */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
        }
        /* Custom styles for the responsive textarea input */
        #user-input {
            min-height: 48px;
            max-height: 120px; /* Max height for about 5 lines */
        }
        /* New style to make headers look clean inside the bubble */
        .ai-bubble h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            margin-top: 10px;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        /* New style for Markdown lists */
        .ai-bubble ul {
            margin-left: 20px;
            list-style: disc;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        /* Style for external links inside the bubble */
        .ai-bubble a {
            color: #4f46e5; /* Indigo-600 */
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold">Environmental Studies Study Buddy</h1>
            <button id="new-chat-button" class="text-sm bg-indigo-500 hover:bg-indigo-700 transition duration-150 py-1.5 px-3 rounded-full font-medium">
                New Study Session
            </button>
        </header>

        <!-- Message Area -->
        <main id="chat-messages"></main>

        <!-- Status Bar and Input -->
        <div id="status-bar" class="p-2 text-center text-sm font-medium bg-gray-100 text-gray-600 hidden">
            Assistant is thinking...
        </div>

        <!-- Input and Send Area (Now using a textarea for wrapping text) -->
        <footer class="p-4 border-t border-gray-200 flex space-x-3 bg-white rounded-b-xl">
            <textarea id="user-input" placeholder="Type your message..." rows="1" 
                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 outline-none resize-none overflow-y-auto" 
                autocomplete="off"></textarea>
            <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg disabled:opacity-50" disabled>
                Send
            </button>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: These values are now safely handled by the Vercel Serverless Function (api/chat.js).
        const API_KEY = ""; 
        const ASSISTANT_ID = ""; // Only needed for context, but not used in client logic.

        // --- DOM Elements ---
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const newChatButton = document.getElementById('new-chat-button');
        const statusBar = document.getElementById('status-bar');
        
        // --- State Management ---
        let threadId = null;
        let isSending = false;
        
        // --- API & UI Helpers ---

        // Helper function to display temporary status messages (like "Copied")
        function displayStatus(message, isError = false) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-24 right-4 p-3 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }

        function copyMessageToClipboard(content) {
            // Use document.execCommand('copy') for compatibility in iframe/sandbox environments
            const tempElement = document.createElement('textarea');
            tempElement.value = content;
            document.body.appendChild(tempElement);
            tempElement.select();
            document.execCommand('copy');
            document.body.removeChild(tempElement);
            displayStatus("Copied to clipboard!");
        }

        // Handles the auto-sizing of the textarea for multi-line prompts
        function adjustTextareaHeight() {
            userInput.style.height = 'auto'; // Reset height
            userInput.style.height = userInput.scrollHeight + 'px';
            // Enable/Disable send button based on content
            sendButton.disabled = isSending || userInput.value.trim() === "";
        }

        // === NEW MARKDOWN CONVERSION LOGIC ===
        function convertMarkdownToHtml(markdownText) {
            let htmlText = markdownText;

            // 1. Convert Links: [Text](URL) -> <a href="URL" target="_blank">Text</a>
            // The target="_blank" ensures the link opens in a new tab, which is crucial when embedded in Canvas/iframe.
            htmlText = htmlText.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');

            // 2. Convert Headers (###, ##) to HTML <h3>/<h2>
            htmlText = htmlText.replace(/###\s*(.*)/g, '<h3>$1</h3>'); 
            htmlText = htmlText.replace(/##\s*(.*)/g, '<h2>$1</h2>'); 

            // 3. Convert Bold Text (**text**) to <strong>
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 4. Convert Unordered Lists (- item) to <ul> and <li>
            const listRegex = /^(-[^\n]+)/gm;
            if (htmlText.match(listRegex)) {
                let listContent = '';
                htmlText = htmlText.replace(listRegex, (match) => {
                    return `<li>${match.substring(2).trim()}</li>`;
                });
                // Wrap adjacent <li>s in <ul>
                htmlText = htmlText.replace(/(<\/li>)(<br>)?\s*<li/g, '</li><li');
                htmlText = htmlText.replace(/(^|\n)(<li>.*?<\/li>)/gs, (match, p1, p2) => {
                    return `<ul>${p2}</ul>`;
                });
                // Clean up any extra HTML tags created during replacement process
                htmlText = htmlText.replace(/<\/ul>(\s*<br>\s*)?<ul>/g, '');
            }

            // 5. Convert remaining single newlines to <br> for line breaks
            htmlText = htmlText.replace(/(?<!(<\/h[1-6]>|<\/li>|<\/ul>)\s*)(\n)/g, '<br>');
            
            // Final cleanup of redundant <br> tags near list/header elements
            htmlText = htmlText.replace(/<br>\s*<h3>/g, '<h3>');
            htmlText = htmlText.replace(/<\/h3><br>/g, '</h3>');
            htmlText = htmlText.replace(/<br>\s*<ul>/g, '<ul>');
            htmlText = htmlText.replace(/<\/li><br>/g, '</li>');
            

            return htmlText;
        }

        function appendMessage(content, role) {
            const messageDiv = document.createElement('div');
            const bubble = document.createElement('div');
            
            // Set styles based on role
            if (role === 'user') {
                messageDiv.className = 'flex justify-end';
                bubble.className = 'message-bubble bg-indigo-600 text-white';
            } else {
                messageDiv.className = 'flex justify-start';
                bubble.className = 'message-bubble bg-gray-200 text-gray-800 ai-bubble'; // Added ai-bubble for custom styles
            }

            const contentContainer = document.createElement('div');
            
            // --- APPLY MARKDOWN CONVERSION HERE ---
            if (role === 'assistant') {
                 contentContainer.innerHTML = convertMarkdownToHtml(content);
            } else {
                 contentContainer.innerHTML = content.replace(/\n/g, '<br>'); // Simple user text formatting
            }
            // ------------------------------------

            const header = document.createElement('div');
            header.className = 'font-semibold mb-1 text-sm';
            header.textContent = role === 'assistant' ? 'Assistant' : 'You';
            
            bubble.appendChild(header);
            bubble.appendChild(contentContainer);


            if (role === 'assistant') {
                const actionRow = document.createElement('div');
                actionRow.className = 'flex justify-end items-center mt-2';
                
                // Copy Button HTML (Inline SVG Icon)
                const copyButton = document.createElement('button');
                copyButton.className = 'text-indigo-700 hover:text-indigo-900 transition-colors p-1 rounded';
                copyButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 1 1 0 01-1-1 1 1 0 100-2 3 3 0 00-3 3h-1.5a1 1 0 000 2H11a3 3 0 00-3-3zM10 9a1 1 0 000 2v3a1 1 0 102 0v-3a1 1 0 00-2 0z" />
                    </svg>
                `;
                copyButton.onclick = () => copyMessageToClipboard(content);
                
                // Ensure the copy button is outside the main content but inside the bubble
                bubble.appendChild(actionRow);
                actionRow.appendChild(copyButton);

            }

            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }

        function toggleLoading(isLoading) {
            isSending = isLoading;
            sendButton.disabled = isLoading || userInput.value.trim() === "";
            newChatButton.disabled = isLoading;
            statusBar.style.display = isLoading ? 'block' : 'none';
        }

        // --- Core Logic ---

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isSending) return;

            toggleLoading(true);
            
            // 1. Display user message
            appendMessage(message, 'user');
            userInput.value = '';
            adjustTextareaHeight();

            try {
                // 2. Call Vercel Serverless Function (secure proxy)
                // Note: Assuming your Vercel endpoint is /api/chat based on your code structure.
                const response = await fetch('/api/chat', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, threadId })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // 3. Update thread ID and display assistant message
                threadId = data.threadId; // Store the new or existing thread ID
                appendMessage(data.assistantMessage, 'assistant');

            } catch (error) {
                console.error('Chat Error:', error);
                appendMessage(`[System Error: Could not connect to the Study Buddy. Please check your Vercel logs. Details: ${error.message}]`, 'assistant');
                displayStatus('Failed to get response!', true);
            } finally {
                toggleLoading(false);
                userInput.focus();
            }
        }

        function startNewSession() {
            // Clear the old conversation and reset the thread ID
            chatMessages.innerHTML = '';
            threadId = null; 
            appendWelcomeMessage();
        }

        function appendWelcomeMessage() {
            const welcomeMessage = "Welcome to Study Buddy, Mr. Carey's tireless assistant to help you with Enviornmental Science 24/7!";
            appendMessage(welcomeMessage, 'assistant');
        }

        // --- Event Listeners and Initialization ---

        function init() {
            // Set up button handlers
            sendButton.addEventListener('click', sendMessage);
            newChatButton.addEventListener('click', startNewSession);

            // Handle Enter keypress
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevents adding a new line
                    sendMessage();
                }
            });

            // Handle auto-height and button state for the textarea
            userInput.addEventListener('input', adjustTextareaHeight);

            // Start the first session
            startNewSession();
            
            // Auto-focus on the input field for immediate typing
            userInput.focus(); 
        }

        window.onload = init;
    </script>
</body>
</html>
