<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Division Dojo</title>
    
    <!-- React & ReactDOM (Development Version for easy debugging, switch to production for live if desired) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for parsing JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVGs to avoid dependencies) ---
        const Icon = ({ size = 24, color = "currentColor", strokeWidth = 2, fill = "none", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 5v7h7" /></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12" /></Icon>;
        const HelpCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const ArrowDown = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19" /><polyline points="19 12 12 19 5 12" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const ChevronRight = (props) => <Icon {...props}><polyline points="9 18 15 12 9 6" /></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;


        // --- Main Application ---
        const LongDivisionApp = () => {
            // --- Constants for Layout ---
            const DIGIT_W = 40; 
            const ROW_H = 50;   

            // --- State Management ---
            const [phase, setPhase] = useState('SETUP'); // SETUP, SOLVING, COMPLETED
            const [dividend, setDividend] = useState('');
            const [divisor, setDivisor] = useState('');
            
            // Algorithm State
            const [step, setStep] = useState('DIVIDE'); // DIVIDE, MULTIPLY, SUBTRACT, BRING_DOWN
            const [cursor, setCursor] = useState(0); 
            const [groupStart, setGroupStart] = useState(0); 
            const [currentWorkingValue, setCurrentWorkingValue] = useState(0); 
            const [quotientMap, setQuotientMap] = useState({}); 
            
            // Visual History
            const [history, setHistory] = useState([]);
            
            // User Interaction
            const [userInput, setUserInput] = useState('');
            const [feedback, setFeedback] = useState({ type: '', msg: '' });
            const [mistakeCount, setMistakeCount] = useState(0);
            
            const inputRef = useRef(null);

            // --- Helpers ---
            
            const getDividendArray = () => dividend.toString().split('').map(Number);
            
            const initializeSolver = () => {
                const divNum = parseInt(dividend);
                const sorNum = parseInt(divisor);
                
                if (!divNum || !sorNum || sorNum === 0) {
                    setFeedback({ type: 'error', msg: 'Please enter valid numbers.' });
                    return;
                }

                const dStr = divNum.toString();
                const sorVal = sorNum;
                
                let startIdx = 0;
                let endIdx = 0;
                let currentVal = parseInt(dStr[0]);

                while (currentVal < sorVal && endIdx < dStr.length - 1) {
                    endIdx++;
                    currentVal = parseInt(dStr.substring(startIdx, endIdx + 1));
                }

                setPhase('SOLVING');
                setStep('DIVIDE');
                setCursor(endIdx);
                setGroupStart(startIdx);
                setCurrentWorkingValue(currentVal);
                setQuotientMap({});
                setHistory([]);
                setUserInput('');
                setFeedback({ type: 'neutral', msg: `How many times does ${sorNum} go into ${currentVal}?` });
                setMistakeCount(0);
            };

            const handleCheck = () => {
                const userVal = parseInt(userInput);
                const sorVal = parseInt(divisor);
                
                if (isNaN(userVal)) return;

                let isCorrect = false;
                let successMsg = '';
                let nextStep = step;
                let nextFeedback = '';

                if (step === 'DIVIDE') {
                    const correctVal = Math.floor(currentWorkingValue / sorVal);
                    if (userVal === correctVal) {
                        isCorrect = true;
                        setQuotientMap(prev => ({ ...prev, [cursor]: userVal }));
                        nextStep = 'MULTIPLY';
                        successMsg = 'Correct!';
                        nextFeedback = `Now, multiply ${userVal} by ${sorVal}.`;
                    } else {
                        setFeedback({ type: 'error', msg: userVal > correctVal ? 'Too high!' : 'Too low!' });
                    }
                } 
                
                else if (step === 'MULTIPLY') {
                    const currentQuotientDigit = quotientMap[cursor];
                    const correctVal = currentQuotientDigit * sorVal;
                    if (userVal === correctVal) {
                        isCorrect = true;
                        setHistory(prev => [...prev, { 
                            value: userVal, 
                            type: 'subtraction', 
                            indent: groupStart, 
                            length: currentWorkingValue.toString().length 
                        }]);
                        nextStep = 'SUBTRACT';
                        successMsg = 'Good job!';
                        nextFeedback = `Subtract ${userVal} from ${currentWorkingValue}.`;
                    } else {
                        setFeedback({ type: 'error', msg: `Check your math: ${currentQuotientDigit} ร ${sorVal} = ?` });
                    }
                } 
                
                else if (step === 'SUBTRACT') {
                    const currentQuotientDigit = quotientMap[cursor];
                    const product = currentQuotientDigit * sorVal;
                    const correctVal = currentWorkingValue - product;
                    
                    if (userVal === correctVal) {
                        isCorrect = true;
                        
                        // Align result to the right (cursor position)
                        const resultIndent = cursor; 
                        
                        setHistory(prev => [...prev, { 
                            value: userVal, 
                            type: 'result', 
                            alignRightIndex: cursor
                        }]);

                        const dArr = getDividendArray();
                        if (cursor >= dArr.length - 1) {
                            nextStep = 'COMPLETED';
                            setPhase('COMPLETED');
                            successMsg = 'You finished!';
                        } else {
                            nextStep = 'BRING_DOWN';
                            successMsg = 'Correct subtraction.';
                            nextFeedback = `Bring down the next number (${dArr[cursor + 1]}).`;
                            setCurrentWorkingValue(userVal); 
                        }
                    } else {
                        setFeedback({ type: 'error', msg: `${currentWorkingValue} - ${product} is not ${userVal}` });
                    }
                } 
                
                else if (step === 'BRING_DOWN') {
                    const dArr = getDividendArray();
                    const nextDigit = dArr[cursor + 1];
                    const correctVal = parseInt(`${currentWorkingValue}${nextDigit}`);
                    
                    // User can type the full new number (e.g. 14) or just the digit (4)
                    if (userVal === nextDigit || userVal === correctVal) {
                        isCorrect = true;
                        const newWorkingVal = parseInt(`${currentWorkingValue}${nextDigit}`);
                        setCurrentWorkingValue(newWorkingVal);
                        
                        const newCursor = cursor + 1;
                        setCursor(newCursor);
                        setGroupStart(newCursor - newWorkingVal.toString().length + 1);

                        // VITAL CHANGE: Update the last history row (the subtraction result)
                        // to include the brought down digit. This makes it persist visually.
                        setHistory(prev => {
                            const newHistory = [...prev];
                            const lastIdx = newHistory.length - 1;
                            if (lastIdx >= 0) {
                                newHistory[lastIdx] = {
                                    ...newHistory[lastIdx],
                                    value: newWorkingVal, // Change '1' to '14'
                                    alignRightIndex: newCursor // Align it to the new column
                                };
                            }
                            return newHistory;
                        });

                        nextStep = 'DIVIDE';
                        successMsg = 'Moved down.';
                        nextFeedback = `How many times does ${sorVal} go into ${newWorkingVal}?`;
                    } else {
                        setFeedback({ type: 'error', msg: `Bring down the digit at index ${cursor + 1} which is ${nextDigit}` });
                    }
                }

                if (isCorrect) {
                    setStep(nextStep);
                    setFeedback({ type: 'success', msg: nextFeedback });
                    setUserInput('');
                    setMistakeCount(0);
                    if (inputRef.current) inputRef.current.focus();
                } else {
                    setMistakeCount(prev => prev + 1);
                }
            };

            const reset = () => {
                setPhase('SETUP');
                setDividend('');
                setDivisor('');
                setStep('DIVIDE');
                setHistory([]);
                setQuotientMap({});
            };

            // --- Render Functions ---

            const renderDividendDigits = () => {
                const digits = getDividendArray();
                return digits.map((d, i) => {
                    // Highlight logic
                    const isCurrentlyProcessing = i >= groupStart && i <= cursor;
                    const isBringDownTarget = step === 'BRING_DOWN' && i === cursor + 1;
                    
                    let bgClass = "";
                    let textClass = "text-slate-800";

                    if (phase === 'SOLVING' && step !== 'BRING_DOWN' && isCurrentlyProcessing) {
                        bgClass = "bg-blue-100 rounded-sm";
                        textClass = "text-blue-700 font-bold";
                    } else if (isBringDownTarget) {
                        textClass = "text-orange-500 font-extrabold animate-bounce";
                    }

                    return (
                        <div 
                            key={i} 
                            className={`flex justify-center items-center ${bgClass}`}
                            style={{ width: DIGIT_W, height: ROW_H }}
                        >
                            <span className={`text-2xl font-mono ${textClass}`}>{d}</span>
                        </div>
                    );
                });
            };

            const renderQuotientDigits = () => {
                const dArr = getDividendArray();
                return dArr.map((_, i) => {
                    const val = quotientMap[i];
                    const isJustEntered = i === cursor && step === 'MULTIPLY';
                    
                    return (
                        <div 
                            key={i} 
                            className="flex justify-center items-end pb-1"
                            style={{ width: DIGIT_W, height: ROW_H }}
                        >
                            <span className={`text-2xl font-mono transition-all duration-300 ${
                                isJustEntered ? "text-green-600 font-bold scale-125" : 
                                val !== undefined ? "text-slate-800" : "opacity-0"
                            }`}>
                                {val !== undefined ? val : '0'}
                            </span>
                        </div>
                    );
                });
            };

            const renderHistoryRows = () => {
                return history.map((row, idx) => {
                    // Calculate indentation
                    let marginLeft = 0;
                    let content = null;

                    if (row.type === 'subtraction') {
                        marginLeft = row.indent * DIGIT_W;
                        const valStr = row.value.toString();
                        content = (
                            <div className="flex relative">
                                <span className="absolute -left-4 top-2 text-slate-400 font-mono">-</span>
                                {valStr.split('').map((char, cIdx) => (
                                    <div key={cIdx} style={{ width: DIGIT_W, height: ROW_H }} className="flex justify-center items-center">
                                        <span className="text-xl font-mono text-slate-500 underline decoration-slate-300 decoration-2 underline-offset-4">{char}</span>
                                    </div>
                                ))}
                            </div>
                        );
                    } else if (row.type === 'result') {
                        const valStr = row.value.toString();
                        // Start index is end index - length + 1
                        const startIdx = row.alignRightIndex - valStr.length + 1;
                        marginLeft = startIdx * DIGIT_W;
                        
                        content = (
                            <div className="flex">
                                {valStr.split('').map((char, cIdx) => {
                                    // Check if this specific character is the "brought down" digit
                                    // The brought down digit is usually the last one in the new combined number
                                    const isBroughtDown = (idx === history.length - 1) && (cIdx === valStr.length - 1) && (valStr.length > 1 || valStr !== currentWorkingValue.toString());
                                    // Simplified visual logic: just render normally, the animation happens in the step before
                                    
                                    return (
                                        <div key={cIdx} style={{ width: DIGIT_W, height: ROW_H }} className="flex justify-center items-center">
                                            <span className={`text-2xl font-mono font-bold ${isBroughtDown ? 'text-slate-800' : 'text-slate-800'}`}>{char}</span>
                                        </div>
                                    )
                                })}
                                {/* Visual Ghost for Bring Down (Only shows during the Bring Down step) */}
                                {idx === history.length - 1 && step === 'BRING_DOWN' && (
                                <div style={{ width: DIGIT_W, height: ROW_H }} className="flex justify-center items-center animate-pulse">
                                    <span className="text-2xl font-mono text-orange-400 opacity-50">
                                        {getDividendArray()[cursor + 1]}
                                    </span>
                                    <ArrowDown size={16} className="text-orange-400 ml-[-25px] mt-[-30px]" />
                                </div>
                                )}
                            </div>
                        );
                    }

                    return (
                        <div key={idx} className="flex" style={{ marginLeft }}>
                            {content}
                        </div>
                    );
                });
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col items-center py-8">
                
                <header className="mb-6 text-center">
                    <h1 className="text-3xl font-extrabold text-slate-700 tracking-tight flex items-center justify-center gap-3">
                    <div className="bg-blue-600 text-white p-2 rounded-lg shadow-md">รท</div>
                    Division Dojo
                    </h1>
                </header>

                <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 min-h-[600px] flex flex-col">
                    
                    {phase === 'SETUP' && (
                    <div className="flex-1 flex flex-col items-center justify-center p-10 animate-in fade-in duration-500">
                        <div className="flex flex-col md:flex-row gap-6 items-center w-full justify-center mb-10">
                        <div className="flex flex-col gap-2">
                            <label className="font-semibold text-slate-600 ml-1 text-sm uppercase tracking-wide">Dividend (Inside)</label>
                            <input 
                            type="number" 
                            value={dividend}
                            onChange={(e) => setDividend(e.target.value)}
                            className="text-4xl p-4 w-48 text-center border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all font-mono"
                            placeholder="852"
                            />
                        </div>
                        <span className="text-5xl text-slate-300 font-light hidden md:block mt-6">รท</span>
                        <div className="flex flex-col gap-2">
                            <label className="font-semibold text-slate-600 ml-1 text-sm uppercase tracking-wide">Divisor (Outside)</label>
                            <input 
                            type="number" 
                            value={divisor}
                            onChange={(e) => setDivisor(e.target.value)}
                            className="text-4xl p-4 w-32 text-center border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all font-mono"
                            placeholder="4"
                            />
                        </div>
                        </div>
                        
                        <button 
                        onClick={initializeSolver}
                        className="bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2"
                        >
                        <Play size={24} fill="currentColor" /> Start Solving
                        </button>
                    </div>
                    )}

                    {(phase === 'SOLVING' || phase === 'COMPLETED') && (
                    <div className="flex flex-col md:flex-row h-full flex-1">
                        
                        {/* --- VISUALIZER AREA --- */}
                        <div className="flex-1 bg-white p-8 overflow-auto border-b md:border-b-0 md:border-r border-slate-100 flex justify-center items-start pt-16">
                        <div className="inline-flex flex-col items-start select-none">
                            
                            {/* Layout: Grid-like structure using Flex */}
                            
                            {/* Row 1: Quotient Area (Above the line) */}
                            <div className="flex">
                                {/* Space above divisor */}
                                <div className="flex justify-end items-end px-2" style={{ width: 80, height: ROW_H }}></div>
                                {/* Quotient Digits */}
                                <div className="flex">
                                    {renderQuotientDigits()}
                                </div>
                            </div>

                            {/* Row 2: Problem Area (Divisor | Dividend) */}
                            <div className="flex">
                                {/* Divisor Cell */}
                                <div className="flex justify-end items-center px-3 relative" style={{ width: 80, height: ROW_H }}>
                                    <span className={`text-3xl font-mono ${['DIVIDE','MULTIPLY'].includes(step) ? 'text-blue-600 font-bold scale-110' : 'text-slate-600'} transition-all`}>
                                        {divisor}
                                    </span>
                                    {/* The Curved Bracket SVG */}
                                    <svg className="absolute right-0 top-0 h-full w-4 text-slate-800" viewBox="0 0 10 50" preserveAspectRatio="none">
                                        <path d="M0,0 Q10,25 0,50" fill="none" stroke="currentColor" strokeWidth="2.5" />
                                    </svg>
                                </div>

                                {/* Dividend Area with Top Border */}
                                <div className="flex border-t-2 border-slate-800 relative">
                                    {renderDividendDigits()}
                                </div>
                            </div>

                            {/* Row 3+: History Area */}
                            <div className="flex flex-col">
                                {/* History Container matches layout of right side */}
                                <div className="flex" style={{ paddingLeft: 80 }}> {/* 80px matches Divisor width */}
                                    <div className="flex flex-col">
                                        {renderHistoryRows()}
                                    </div>
                                </div>
                            </div>

                        </div>
                        </div>

                        {/* --- CONTROLS AREA --- */}
                        <div className="w-full md:w-80 bg-slate-50 p-6 flex flex-col">
                        
                        <div className="flex justify-between items-center mb-6">
                            <span className={`text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-sm ${phase === 'COMPLETED' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                            {phase === 'COMPLETED' ? 'Done' : step.replace('_', ' ')}
                            </span>
                            <button onClick={reset} className="text-slate-400 hover:text-red-500 transition-colors bg-white p-2 rounded-full shadow-sm" title="Restart">
                            <RotateCcw size={16} />
                            </button>
                        </div>

                        {phase === 'COMPLETED' ? (
                            <div className="flex flex-col items-center justify-center h-full text-center gap-4 animate-in zoom-in duration-300">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2 ring-4 ring-green-50">
                                <Check size={40} strokeWidth={4} />
                            </div>
                            <div>
                                <h3 className="text-2xl font-bold text-slate-800">Solved!</h3>
                                <p className="text-slate-500 mt-1 font-mono text-lg mb-4">
                                    Quotient: <span className="font-bold text-slate-800">{Object.values(quotientMap).join('')}</span>
                                    {history[history.length-1]?.value > 0 && <span className="text-slate-500 ml-2">R {history[history.length-1].value}</span>}
                                </p>
                                
                                {/* Educational Content about Remainder */}
                                {history.length > 0 && history[history.length-1].value > 0 ? (
                                    <div className="bg-blue-50 p-4 rounded-xl text-left border border-blue-100">
                                        <div className="flex items-center gap-2 mb-2 text-blue-700 font-bold">
                                            <BookOpen size={18} />
                                            <span>About the Remainder</span>
                                        </div>
                                        <p className="text-sm text-slate-600 leading-relaxed">
                                            We have <strong>{history[history.length-1].value}</strong> left over. 
                                            Since <strong>{history[history.length-1].value}</strong> is smaller than the divisor <strong>{divisor}</strong>, we can't divide any further! 
                                            That's why it's called the "Remainder".
                                        </p>
                                    </div>
                                ) : (
                                    <div className="bg-green-50 p-4 rounded-xl text-left border border-green-100">
                                        <p className="text-sm text-green-700 leading-relaxed text-center">
                                            No remainder! The number divided perfectly.
                                        </p>
                                    </div>
                                )}

                            </div>
                            <button onClick={reset} className="mt-6 w-full bg-slate-800 text-white py-3 px-6 rounded-xl font-semibold hover:bg-slate-700 transition-all shadow-lg">
                                New Problem
                            </button>
                            </div>
                        ) : (
                            <div className="flex flex-col flex-1">
                            
                            {/* Assistant Bubble */}
                            <div className={`p-5 rounded-2xl mb-6 shadow-sm border relative transition-colors duration-300 ${
                                feedback.type === 'error' ? 'bg-red-50 border-red-100' : 
                                feedback.type === 'success' ? 'bg-green-50 border-green-100' : 
                                'bg-white border-slate-200'
                            }`}>
                                {/* Tail for speech bubble */}
                                <div className={`absolute top-full left-8 w-4 h-4 transform rotate-45 -mt-2 border-r border-b ${
                                feedback.type === 'error' ? 'bg-red-50 border-red-100' : 
                                feedback.type === 'success' ? 'bg-green-50 border-green-100' : 
                                'bg-white border-slate-200'
                                }`}></div>

                                <div className="flex gap-3">
                                    <div className={`mt-1 shrink-0 ${
                                        feedback.type === 'error' ? 'text-red-500' : 
                                        feedback.type === 'success' ? 'text-green-500' : 
                                        'text-blue-500'
                                    }`}>
                                    {feedback.type === 'error' ? <X size={24} /> : 
                                        feedback.type === 'success' ? <Check size={24} /> : 
                                        <HelpCircle size={24} />}
                                    </div>
                                    <div>
                                        <p className="text-lg font-medium text-slate-800 leading-snug">
                                            {feedback.msg || "Let's start!"}
                                        </p>
                                        {mistakeCount > 2 && (
                                            <div className="mt-3 pt-3 border-t border-slate-200/50">
                                                <p className="text-sm text-slate-500 font-medium">Hint:</p>
                                                <p className="text-sm text-slate-600 italic">
                                                    {step === 'DIVIDE' && `How many ${divisor}s fit inside ${currentWorkingValue}?`}
                                                    {step === 'MULTIPLY' && `Multiply the top number (${quotientMap[cursor]}) by ${divisor}.`}
                                                    {step === 'SUBTRACT' && `What is ${currentWorkingValue} minus ${quotientMap[cursor] * divisor}?`}
                                                    {step === 'BRING_DOWN' && `Type the digit highlighted in orange.`}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Input Controls */}
                            <div className="mt-auto">
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                Enter Value
                                </label>
                                <div className="flex gap-2">
                                <input
                                    ref={inputRef}
                                    type="number"
                                    value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleCheck()}
                                    className="flex-1 text-3xl p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all font-mono text-center"
                                    placeholder="?"
                                    autoFocus
                                />
                                <button 
                                    onClick={handleCheck}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl transition-colors shadow-lg shadow-blue-200 active:scale-95"
                                >
                                    <ChevronRight size={32} />
                                </button>
                                </div>
                            </div>

                            </div>
                        )}
                        </div>
                    </div>
                    )}
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LongDivisionApp />);
    </script>
</body>
</html>
