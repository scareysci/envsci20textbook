<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Science 20 Textbook</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 bg-stone-100">
    <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
        <h1 class="text-3xl font-bold text-stone-900 mb-8">Environmental Science 20 Textbook</h1>
        
        <!-- Search Functionality -->
        <div class="mb-8">
            <form id="searchForm" class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="searchInput" placeholder="Search the textbook..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                <button type="submit" class="px-6 py-2 bg-stone-700 text-white font-semibold rounded-lg shadow-md hover:bg-stone-800 transition duration-300">Search</button>
            </form>
            <div id="messageBox" class="mt-2 text-sm text-red-500"></div>
            <div id="results" class="mt-4 text-left"></div>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-stone-700 mb-4">Aquatic Ecosystems</h2>
            <div class="grid grid-cols-1 gap-4">
                <!-- Row for Hydrologic Cycle -->
                <a href="part1.html" class="p-4 bg-amber-600 text-white font-semibold rounded-lg shadow-md hover:bg-amber-700 transition duration-300 transform hover:scale-105">
                    Hydrologic Cycle
                </a>
                
                <!-- Row for Types of Aquatic Ecosystems -->
                <a href="part2.html" class="p-4 bg-lime-700 text-white font-semibold rounded-lg shadow-md hover:bg-lime-800 transition duration-300 transform hover:scale-105">
                    Types of Aquatic Ecosystems
                </a>

                <!-- NEW ROW for Abiotic Factors -->
                <a href="part3.html" class="p-4 bg-lime-700 text-white font-semibold rounded-lg shadow-md hover:bg-lime-800 transition duration-300 transform hover:scale-105">
                    Abiotic Factors of Aquatic Ecosystems
                </a>
            </div>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-stone-700 mb-4">Terrestrial Ecosystems</h2>
            <div class="p-4 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md">
                More chapters coming soon...
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const messageBox = document.getElementById('messageBox');
            const resultsDiv = document.getElementById('results');

            const textbookPages = [
                {
                    title: 'Hydrologic Cycle',
                    url: 'https://scareysci.github.io/envsci20textbook/part1.html',
                    doc: null
                },
                {
                    title: 'Types of Aquatic Ecosystems',
                    url: 'https://scareysci.github.io/envsci20textbook/part2.html',
                    doc: null
                },
                // Added the new chapter for search indexing
                {
                    title: 'Abiotic Factors of Aquatic Ecosystems',
                    url: 'https://scareysci.github.io/envsci20textbook/part3.html',
                    doc: null
                }
            ];

            const fetchAllContent = async () => {
                try {
                    messageBox.textContent = 'Loading content for search...';
                    const fetchPromises = textbookPages.map(async (page) => {
                        // Implement exponential backoff for fetching content
                        const maxRetries = 3;
                        let lastError = null;
                        for (let i = 0; i < maxRetries; i++) {
                            try {
                                const response = await fetch(page.url);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                const text = await response.text();
                                const parser = new DOMParser();
                                page.doc = parser.parseFromString(text, 'text/html');
                                return; // Success
                            } catch (error) {
                                lastError = error;
                                if (i < maxRetries - 1) {
                                    const delay = Math.pow(2, i) * 1000;
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                }
                            }
                        }
                        // If all retries fail, re-throw the last error
                        if (lastError) throw lastError;
                    });
                    await Promise.all(fetchPromises);
                    messageBox.textContent = '';
                } catch (error) {
                    console.error('Failed to fetch pages:', error);
                    messageBox.textContent = 'Error loading content for search.';
                }
            };

            fetchAllContent();

            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const searchTerm = searchInput.value.toLowerCase().trim();
                resultsDiv.innerHTML = '';
                messageBox.textContent = '';
                
                if (searchTerm === '') {
                    messageBox.textContent = 'Please enter a search term.';
                    return;
                }

                let foundResults = false;
                textbookPages.forEach(page => {
                    if (page.doc) {
                        // Use document.body.innerText for reliable text content extraction
                        const pageContent = (page.doc.body.innerText || '').toLowerCase();
                        const searchTermIndex = pageContent.indexOf(searchTerm);

                        if (searchTermIndex !== -1) {
                            foundResults = true;
                            
                            // 1. Get all elements with IDs in the body
                            const allElementsWithId = page.doc.querySelectorAll('body [id]');
                            
                            // 2. Find the closest preceding element
                            let closestHeading = null;
                            let closestHeadingIndex = -1;

                            // We iterate through all elements that have an ID and find the one that appears
                            // right before the location of the search term.
                            allElementsWithId.forEach(element => {
                                // For simplicity, we search the page content again for the element's text to find its index
                                // A more robust solution would track DOM tree positions, but this approach is usually sufficient
                                const elementText = element.textContent.toLowerCase().trim();
                                if (elementText.length > 0) {
                                    const elementIndex = pageContent.indexOf(elementText.substring(0, 30)); // Look at the start of the element's text

                                    if (elementIndex !== -1 && elementIndex < searchTermIndex && elementIndex > closestHeadingIndex) {
                                        // Check if the element is actually a heading (H1-H6)
                                        if (['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(element.tagName)) {
                                            closestHeading = element;
                                            closestHeadingIndex = elementIndex;
                                        }
                                    }
                                }
                            });

                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-2 bg-stone-100 rounded-lg mb-2';

                            if (closestHeading) {
                                // Link to the specific heading ID
                                resultItem.innerHTML = `
                                    <a href="${page.url}#${closestHeading.id}" class="font-semibold text-lime-800 hover:underline">${page.title}: ${closestHeading.textContent}</a>
                                `;
                            } else {
                                // Fallback to linking to the top of the page if no preceding heading is found
                                resultItem.innerHTML = `
                                    <a href="${page.url}" class="font-semibold text-lime-800 hover:underline">${page.title}</a>
                                `;
                            }
                            resultsDiv.appendChild(resultItem);
                        }
                    }
                });

                if (!foundResults) {
                    messageBox.textContent = 'No matching results found.';
                }
            });
        });
    </script>
</body>
</html>



